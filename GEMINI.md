# GEMINI.md

## Обзор проекта

Это веб-приложение на базе Laravel 12 под названием **lan-install.online**. Его основная цель — управление заявками на установку и обслуживание 
локальных сетей, установки систем видеонаблюдения (видеокамеры) и монипторинга (панелт) в учебных учреждениях и других организациях разного 
профиля. Приложение включает в себя функции управления рабочими бригадами, создания, редактирования и отслеживания заявок на обслуживание, 
создания отчетов и обработки географических данных с помощью Яндекс.Карт.

## Ключевые рекомендации

* Отвечай на все мои вопросы на русском языке
* Выполнять при необходимости (в том числе при редактировании контроллеров) команду для определения структуры базы данных lan_install, 
используемой в проекте
```bash
sudo psql -U postgres -d lan_install -c "\d
```
* Команду git выполнять только, когда я тебя об этом попрошу
* Новые обработчики JavaScript следует создавать в отдельных файлах в папке `public/js/` (с понятными именами) и подключать их в шаблонах по мере необходимости. Избегать добавления кода в общий файл `form-handlers.js`, если это не общая логика.
* Не размещать код обработчика JS непосредственно в Blade-файлах, таких как `welcome.blade.php`.
* Файл `public/js/init.js` используеть для инициализации обработчиков и другого кода после полной загрузки DOM.
* Придерживаться принципов SOLID при разработке и рефакторинге кода.
* **Безопасность:** Никогда не хардкодить пароли, токены и ключи API в исходном коде или документации (GEMINI.md). Всегда выносить чувствительные данные в переменные окружения (`.env`) или локальные файлы конфигурации (`telegram.conf`), которые добавлены в `.gitignore`.
* **Тестирование уведомлений:** Для проверки работы Telegram-уведомлений на локальной машине или в процессе разработки использовать тестового бота (например, `@FlowboxNotifyBot`). Его токен и ID чата должны находиться исключительно в локальном файле `utils/C/notify-bot/telegram.conf`, чтобы не беспокоить пользователей в боевых чатах.
* **Обновление бинарных утилит:** Поскольку скомпилированные файлы (`telegram_notify`) зависят от архитектуры ОС (macOS vs Linux), они исключены из Git. При внесении изменений в исходный код C (`.c`), необходимо запустить скрипт `./update-bot` для перекомпиляции утилиты непосредственно на сервере.
* **Перед деплоем:** Проанализируй внимательно вывод команды git diff и оцени, могли ли внесённые изменения нарушить корректную работу существующего кода, нет ли в изменениях чувствительных данных? Обрати внимание на потенциальные регрессии, изменения в логике, сигнатурах функций, обработке ошибок или зависимостях. И, если все в порядке, то выполни команду git status && git diff и опиши мне ответы по итогам этих изменений в проекте - это нужно для комментария коммита в соответствии с Conventional Commits, отвечай на русском языке. В тексте ответа не должно быть двойных кавычек, или заменяй их одинарными. Настойчиво прошу: текст комментария для коммита выводи в консоль на русском языке! После этого сразу вызывай команду `./git-deploy "сообщение"`, не задавая лишних вопросов (подтверждение я дам через интерфейс CLI).
* **Деплой:** Для выкладки изменений на сервер и синхронизации кода всегда использовать скрипт `./git-deploy "комментарий"`. Он автоматизирует процесс добавления файлов, коммита, отправки в репозиторий, обновления кода на сервере и очистки кэша Laravel.

## Ключевые технологии:

* **Бэкенд:** Laravel 12 (PHP)
* **Фронтенд:** JavaScript, Tailwind CSS, Bootstrap
* **База данных:** Postgresql
* **API:** Яндекс.Карты
* **bash скрипты** для автоматизации прикладных задач и просмотра логов:
    *   `./git-deploy "комментарий"` — Основной инструмент деплоя. Автоматизирует добавление файлов, коммит, отправку в Git, обновление кода на сервере и очистку серверного кэша.
    *   `./update-bot` — Перекомпиляция C-исходников Telegram-бота и обновление бинарного файла.
    *   `./clear-cash` — Полная очистка кэша конфигурации, маршрутов, представлений и общего кэша приложения Laravel.
    *   `./url_gen.sh [ID_адреса]` — Генерация публичной защищенной ссылки с токеном для просмотра истории заявок по конкретному адресу.
    *   `./show-logs` — Просмотр логов Laravel в реальном времени (`tail -f`).
    *   `./serve` — Быстрый запуск локального сервера разработки.
    *   `./ls-controllers-views` — Вывод списка всех контроллеров и шаблонов проекта для быстрой навигации.
    *   `./commit-list` — Просмотр истории коммитов за последние 2 недели в форматированном виде.
    *   `./backup_db_remote` — Запуск резервного копирования базы данных.

## Архитектура:

Проект следует стандартной архитектуре Laravel MVC (модель-представление-контроллер).

* **Модели:** Не используюся в проекте, применются нативные sql запросы и фасад DB для доступа к объектам базы данных. 
* **Представления:** Шаблоны Blade, расположенные в каталоге `resources/views/`, отвечают за уровень представления.
* **Контроллеры:** Расположены в каталоге `app/Http/Controllers/`, обрабатывают пользовательские запросы и бизнес-логику.
* **Маршруты:** Определены в каталогах `routes/web.php` и `routes/api.php`, сопоставляют URL-адреса с действиями контроллера.

## Сборка и запуск

### Необходимые условия:

* PHP 8.2 или выше
* Composer
* Node.js и npm
* Postgresql

### Настройка и запуск:

1. **Установите зависимости PHP:**
```bash
Composer install
```

2. **Установите зависимости JavaScript:**
```bash
npm install
```

3. **Настройте окружение:**

Скопируйте `.env.example` в `.env` и заполните учётные данные вашей базы данных и другие настройки. ```bash
cp .env.example .env
```

4. **Сгенерировать ключ приложения:**
```bash
php artisan key:generate
```

5. **Запустить миграцию базы данных (только системные таблицы):**
```bash
php artisan migrate
```

6. **Заполнить базу данных (необязательно):**
```bash
php artisan db:seed
```

7. **Сборка ресурсов фронтенда:**
```bash
npm run build
```

8. **Запустить сервер разработки:**
```bash
php artisan serve
```
Альтернативно, для создания полноценной среды разработки, включая прослушиватель очереди и журналы, используйте:
```bash
composer run dev
```

## Соглашения о разработке

### Стиль кода:

* В проекте используется стиль PHP-кода `laravel/pint`. Чтобы отформатировать код, выполните:
```bash
vendor/bin/pint
```

### Скрипты автоматизации:

*   При создании новых bash-скриптов всегда добавлять `set -e` сразу после шебанга (`#!/bin/bash`). Это гарантирует остановку скрипта при любой ошибке, предотвращая некорректное выполнение последующих команд.

### API:

* Документация по API доступна в `docs/API.md`.
