# Документация API lan-install.online

## Обзор

API приложения lan-install.online предоставляет RESTful интерфейс для управления заявками на установку сетей, бригадами монтажников, сотрудниками, адресами и отчетностью.

## Аутентификация

Все API запросы требуют аутентификации пользователя. Необходимо передавать CSRF-токен в заголовках:

```
X-CSRF-TOKEN: ваш_csrf_токен
Content-Type: application/json
Accept: application/json
```

## Формат ответов

### Успешный ответ
```json
{
    "success": true,
    "message": "Операция выполнена успешно",
    "data": { ... }
}
```

### Ошибка
```json
{
    "success": false,
    "message": "Описание ошибки",
    "error": "Детали ошибки"
}
```

## Работа с бригадами

### Получение бригад по дате
**GET** `/brigades/date/{date}`

Возвращает список бригад на указанную дату.

### Создание бригады
**POST** `/brigades` *(требует аутентификации и ролей)*

**Параметры:**
- `name` - название бригады
- `leader_id` - ID бригадира
- `members` - массив ID участников

### Получение данных бригады
**POST** `/brigade/{id}`

Возвращает информацию о бригаде по ID.

### Получение текущих бригад
**GET** `/api/brigades/current` *(требует аутентификации)*

### Получение бригад за текущий день
**GET** `/api/brigades/current-day` *(требует аутентификации)*

### Удаление бригады
**POST** `/brigade/delete/{id}` *(требует аутентификации)*

## Работа с заявками

### Создание заявки
**POST** `/api/requests` *(требует аутентификации)*

**Параметры:**
- `address_id` - ID адреса
- `type_id` - тип заявки
- `description` - описание
- `priority` - приоритет

### Получение заявок по дате
**GET** `/api/requests/date/{date}` *(требует аутентификации)*

### Закрытие заявки
**POST** `/requests/{request}/close` *(требует аутентификации и ролей)*

### Удаление заявки
**POST** `/requests/{request}/delete` *(требует аутентификации и ролей)*

### Перенос заявки
**POST** `/api/requests/transfer` *(требует аутентификации)*

**Параметры:**
- `request_id` - ID заявки
- `new_date` - новая дата

### Отмена заявки
**POST** `/requests/cancel` *(требует аутентификации)*

**Параметры:**
- `request_id` - ID заявки

## Работа с бригадами и заявками

### Получение бригады по ID бригадира
**GET** `/api/requests/brigade/by-leader/{leaderId}` *(требует аутентификации)*

**Параметры:**
- `leaderId` (обязательный) - ID бригадира

**Пример успешного ответа:**
```json
{
    "success": true,
    "data": {
        "brigade_id": 11,
        "brigade_name": "Бригада №1",
        "formation_date": "2025-07-01"
    }
}
```

**Коды ошибок:**
- `404` - бригада не найдена
- `500` - внутренняя ошибка сервера

### Обновление бригады у заявки
**POST** `/api/requests/update-brigade` *(требует аутентификации)*

**Параметры запроса (JSON):**
- `brigade_id` (обязательный) - ID бригады
- `request_id` (обязательный) - ID заявки

**Пример успешного ответа:**
```json
{
    "success": true,
    "message": "Бригада успешно прикреплена к заявке",
    "data": {
        "request_id": 28,
        "brigade_id": 11
    }
}
```

**Коды ошибок:**
- `400` - неверные параметры запроса
- `404` - заявка или бригада не найдены
- `500` - внутренняя ошибка сервера

## Работа с адресами

### Получение адресов (пагинация)
**GET** `/api/addresses/paginated` *(требует аутентификации)*

**Параметры запроса:**
- `page` - номер страницы
- `per_page` - количество на странице

### Получение адреса по ID
**GET** `/api/addresses/{id}` *(требует аутентификации)*

### Добавление адреса
**POST** `/api/addresses/add` *(требует аутентификации)*

**Параметры:**
- `city_id` - ID города
- `street` - улица
- `house` - дом
- `coordinates` - координаты

### Обновление адреса
**PUT** `/api/addresses/{id}` *(требует аутентификации)*

### Удаление адреса
**DELETE** `/api/addresses/{id}` *(требует аутентификации)*

## Работа с городами и регионами

### Добавление города
**POST** `/cities/store` *(требует аутентификации)*

**Параметры:**
- `name` - название города
- `region_id` - ID региона

### Получение списка регионов
**GET** `/regions`

## Работа с сотрудниками

### Получение списка сотрудников
**GET** `/employees` *(требует аутентификации)*

### Добавление сотрудника
**POST** `/employees/store` *(требует аутентификации)*

**Параметры:**
- `name` - имя
- `position` - должность
- `passport` - паспортные данные

### Обновление сотрудника
**POST** `/employee/update` *(требует аутентификации)*

### Получение сотрудника
**GET** `/employee/get` *(требует аутентификации)*

**Параметры:**
- `id` - ID сотрудника

### Фильтрация сотрудников
**POST** `/employee/filter` *(требует аутентификации)*

**Параметры:**
- `date_from` - дата от
- `date_to` - дата до
- `position` - должность

### Фильтрация сотрудников по дате
**POST** `/api/employees/filter` *(требует аутентификации)*

### Удаление сотрудника
**POST** `/employee/delete` *(требует аутентификации)*

## Работа с ролями

### Получение списка ролей
**GET** `/api/roles` *(требует аутентификации)*

## Работа с комментариями

### Добавление комментария к заявке
**POST** `/requests/comment` *(требует аутентификации)*

**Параметры:**
- `request_id` - ID заявки
- `text` - текст комментария
- `photos` - массив файлов

### Получение комментариев к заявке
**GET** `/api/requests/{request}/comments` *(требует аутентификации)*

**Ответ:**
Возвращает объект с массивом комментариев и мета-данными.

```json
{
    "comments": [
        {
            "id": 1,
            "comment": "Текст комментария",
            "created_at": "2023-01-01T12:00:00.000000Z",
            "author_name": "Иванов И.И.",
            "formatted_date": "01.01.2023 12:00",
            ...
        }
    ],
    "meta": {
        "address_history_url": "https://.../public/reports/address-history/..." // Ссылка на историю (только для закрытых заявок)
    }
}
```

### Обновление комментария
**PUT** `/api/comments/{id}` *(требует аутентификации)*

**Параметры:**
- `text` - новый текст

### Получение количества комментариев
**GET** `/api/requests/{request}/comments/count` *(требует аутентификации)*

## Работа с фотоотчетами

### Загрузка фотоотчета
**POST** `/api/requests/photo-report` *(требует аутентификации)*

**Параметры:**
- `request_id` - ID заявки
- `photos` - массив файлов

### Получение фотоотчета по заявке
**GET** `/api/photo-report/{requestId}` *(требует аутентификации)*

### Загрузка фото к комментарию
**POST** `/api/requests/photo-comment` *(требует аутентификации)*

### Получение фото комментария
**GET** `/api/comments/{commentId}/photos` *(требует аутентификации)*

### Скачивание всех фото
**POST** `/download-all-photos` *(требует аутентификации)*

**Параметры:**
- `request_id` - ID заявки

## Работа со статусами заявок

### Получение всех статусов
**GET** `/statuses` *(требует аутентификации)*

### Создание статуса
**POST** `/statuses` *(требует аутентификации)*

**Параметры:**
- `name` - название статуса

### Обновление статуса
**PUT** `/statuses/{id}` *(требует аутентификации)*

### Удаление статуса
**DELETE** `/statuses/{id}` *(требует аутентификации)*

### Получение всех статусов для фильтра
**GET** `/api/request-statuses/all` *(требует аутентификации)*

## Фильтры заявок

### Фильтр по статусам
**GET** `/api/requests/by-status` *(требует аутентификации)*

**Параметры:**
- `statuses` - массив ID статусов

### Фильтр по бригадам
**GET** `/api/requests/by-brigade` *(требует аутентификации)*

**Параметры:**
- `brigade_ids` - массив ID бригад

## Работа с бригадирами

### Получение списка бригадиров
**GET** `/api/brigade-leaders` *(требует аутентификации)*

### Информация о бригадах за текущий день
**POST** `/api/brigades/info-current-day` *(требует аутентификации)*

## Работа с пользователями

### Обновление учетных данных пользователя
**PUT** `/api/users/{id}/credentials` *(требует аутентификации)*

**Параметры:**
- `email` - новый email
- `password` - новый пароль

## Отчеты

### Получение адресов для отчетов
**GET** `/reports/addresses` *(требует аутентификации)*

### Получение сотрудников для отчетов
**GET** `/reports/employees` *(требует аутентификации)*

### Отчет по всем заявкам за период
**POST** `/reports/requests/all-period` *(требует аутентификации)*

**Параметры:**
- `date_from` - дата начала
- `date_to` - дата окончания

### Отчет по сотруднику за период
**POST** `/reports/requests/by-employee-all-period` *(требует аутентификации)*

**Параметры:**
- `employee_id` - ID сотрудника
- `date_from` - дата начала
- `date_to` - дата окончания

### Отчет по адресу за период
**POST** `/reports/requests/by-address-all-period` *(требует аутентификации)*

**Параметры:**
- `address_id` - ID адреса
- `date_from` - дата начала
- `date_to` - дата окончания

### Отчет по сотруднику и адресу за период
**POST** `/reports/requests/by-employee-address-all-period` *(требует аутентификации)*

**Параметры:**
- `employee_id` - ID сотрудника
- `address_id` - ID адреса
- `date_from` - дата начала
- `date_to` - дата окончания

### Отчет по датам
**POST** `/reports/requests/by-date` *(требует аутентификации)*

**Параметры:**
- `date_from` - дата начала
- `date_to` - дата окончания

### Отчет по сотруднику и датам
**POST** `/reports/requests/by-employee-date` *(требует аутентификации)*

**Параметры:**
- `employee_id` - ID сотрудника
- `date_from` - дата начала
- `date_to` - дата окончания

### Отчет по адресу и датам
**POST** `/reports/requests/by-address-date` *(требует аутентификации)*

**Параметры:**
- `address_id` - ID адреса
- `date_from` - дата начала
- `date_to` - дата окончания

### Отчет по сотруднику, адресу и датам
**POST** `/reports/requests/by-employee-address-date` *(требует аутентификации)*

**Параметры:**
- `employee_id` - ID сотрудника
- `address_id` - ID адреса
- `date_from` - дата начала
- `date_to` - дата окончания

## Геоданные

### Получение адресов
**GET** `/api/geo/addresses` *(требует аутентификации)*

### Получение городов
**GET** `/api/geo/cities` *(требует аутентификации)*

### Получение регионов
**GET** `/api/geo/regions` *(требует аутентификации)*

### Адреса Яндекс
**GET** `/api/geo/yandex` *(требует аутентификации)*

### Добавление адреса
**POST** `/api/geo/addresses` *(требует аутентификации)*

### Добавление города
**POST** `/api/geo/cities` *(требует аутентификации)*

### Добавление региона
**POST** `/api/geo/regions` *(требует аутентификации)*

## Планирование заявок

### Создание планируемой заявки
**POST** `/planning-requests` *(требует аутентификации)*

**Параметры:**
- `address_id` - ID адреса
- `planned_date` - планируемая дата
- `description` - описание

### Получение планируемых заявок
**POST** `/get-planning-requests` *(требует аутентификации)*

### Изменение статуса планируемой заявки
**POST** `/change-planning-request-status` *(требует аутентификации)*

**Параметры:**
- `request_id` - ID заявки
- `status` - новый статус

## Загрузка файлов

### Загрузка Excel файла
**POST** `/upload-excel` *(требует аутентификации)*

**Параметры:**
- `file` - Excel файл

## Списки для селектов

### Типы заявок
**GET** `/api/request-types` *(требует аутентификации)*

### Статусы заявок
**GET** `/api/request-statuses` *(требует аутентификации)*

### Бригады
**GET** `/api/brigades` *(требует аутентификации)*

### Операторы
**GET** `/api/operators` *(требует аутентификации)*

### Города
**GET** `/api/cities` *(требует аутентификации)*

### Сотрудники
**GET** `/api/employees` *(требует аутентификации)*

### Адреса
**GET** `/api/addresses` *(требует аутентификации)*

## Публичные ссылки (без авторизации)

### Просмотр истории по адресу
**GET** `/public/reports/address-history/{addressId}/{token}`

Возвращает упрощенную страницу с историей всех заявок по указанному адресу. Доступ защищен уникальным токеном, генерируемым на основе секретного ключа приложения.

**Параметры:**
- `addressId` - ID адреса в базе данных.
- `token` - защитный хеш (md5 от addressId + app.key + 'address-history').

## Обработка ошибок

Все ошибки возвращаются в формате:
```json
{
    "success": false,
    "message": "Описание ошибки",
    "error_details": {
        "file": "файл где произошла ошибка",
        "line": 123,
        "code": "код ошибки"
    }
}
```

## Аутентификация

Все запросы требуют аутентификации. В заголовке запроса должен быть передан CSRF-токен.

**Заголовки:**
```
X-CSRF-TOKEN: ваш_csrf_токен
Content-Type: application/json
Accept: application/json
```
